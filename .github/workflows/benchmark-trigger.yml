  name: Benchmark Trigger

  on:
    repository_dispatch:
      types: [new_build]

  jobs:
    run-benchmark:
      runs-on: ubuntu-latest
      permissions:
        contents: read
        packages: read

      steps:
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Set up Docker Buildx
          uses: docker/setup-buildx-action@v3

        - name: Log in to GitHub Container Registry
          uses: docker/login-action@v3
          with:
            registry: ghcr.io
            username: ${{ github.actor }}
            password: ${{ secrets.GITHUB_TOKEN }}

        - name: Extract Metadata from Image
          run: |
            # Set IMAGE_NAME from payload
            IMAGE_NAME="${{ github.event.client_payload.image_name }}"
            echo "IMAGE_NAME=$IMAGE_NAME" >> $GITHUB_ENV
            
            # Debug: Print the IMAGE_NAME
            echo "Debug: IMAGE_NAME='$IMAGE_NAME'"
            
            # Validation: Fail the build if IMAGE_NAME is empty
            if [ -z "$IMAGE_NAME" ]; then
              echo "ERROR: IMAGE_NAME is empty in payload. Check the repository dispatch payload."
              echo "Available payload keys:"
              echo "${{ toJson(github.event.client_payload) }}"
              exit 1
            fi
            
            docker pull "$IMAGE_NAME"
            
            # Extract labels
            RAW_COMMIT=$(docker inspect --format='{{index .Config.Labels "org.opencontainers.image.revision"}}' ${{ env.IMAGE_NAME }})
            RAW_TAG=$(docker inspect --format='{{index .Config.Labels "org.opencontainers.image.ref.name"}}' ${{ env.IMAGE_NAME }})
            
            # Validation: Fail the build if COMMIT is empty
            if [ -z "$RAW_COMMIT" ] || [ "$RAW_COMMIT" == "<no value>" ]; then
            echo "ERROR: OCI Revision (commit) missing in image metadata. Ensure Gradle build passes -PGIT_COMMIT."
            exit 1
            fi
            
            echo "APP_GIT_COMMIT=$RAW_COMMIT" >> $GITHUB_ENV
            echo "APP_GIT_TAG=$RAW_TAG" >> $GITHUB_ENV

        - name: Write Spring environment file
          run: |
            # Combine main spring environment and google account samples
            echo '${{ secrets.SPRING_ENV_FILE_CONTENT }}' > .env.spring.benchmark.part1
            echo '${{ secrets.GOOGLE_ACCOUNT_SAMPLES }}' > .env.spring.benchmark.part2
            
            # Combine both parts into final file
            cat .env.spring.benchmark.part1 .env.spring.benchmark.part2 > .env.spring.benchmark
            
            # Clean up temporary files
            rm .env.spring.benchmark.part1 .env.spring.benchmark.part2

        - name: Run Benchmark
          env:
            # Only benchmark-specific variables
            APP_GIT_COMMIT: ${{ env.APP_GIT_COMMIT }}
            APP_GIT_TAG: ${{ env.APP_GIT_TAG }}
            IMAGE_NAME: ${{ env.IMAGE_NAME }}

            # AI Cost Benchmark configuration
            GEMINI_3_FLASH_PREVIEW_INPUT_TOKEN_PRICE_PER_MILLION: ${{ vars.GEMINI_INPUT_TOKEN_PRICE }}
            GEMINI_3_FLASH_PREVIEW_OUTPUT_TOKEN_PRICE_PER_MILLION: ${{ vars.GEMINI_OUTPUT_TOKEN_PRICE }}
            AI_BENCHMARK_ENABLE_VERBOSE_DOCKER_LOGS: ${{ vars.AI_BENCHMARK_ENABLE_VERBOSE_DOCKER_LOGS }}
            AI_BENCHMARK_ENDPOINT: ${{ vars.AI_BENCHMARK_ENDPOINT }}
            AI_BENCHMARK_K6_ITERATIONS: ${{ vars.AI_BENCHMARK_K6_ITERATIONS }}
            AI_BENCHMARK_K6_WARMUP_ITERATIONS: ${{ vars.AI_BENCHMARK_K6_WARMUP_ITERATIONS }}
            AI_BENCHMARK_REQUEST_TIMEOUT: ${{ vars.AI_BENCHMARK_REQUEST_TIMEOUT }}
          run: |
            chmod +x run-ai-benchmark.sh
            ./run-ai-benchmark.sh

        - name: Upload Results
          uses: actions/upload-artifact@v4
          if: always()
          with:
            name: ai-benchmark-results-${{ env.APP_GIT_COMMIT }}
            path: results/ai-benchmark/
            retention-days: 30
